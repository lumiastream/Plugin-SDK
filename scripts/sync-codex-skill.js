#!/usr/bin/env node

const fsp = require("node:fs/promises");
const path = require("node:path");

const projectRoot = path.resolve(__dirname, "..");
const skillRoot = path.resolve(
	projectRoot,
	"skills",
	"lumia-plugin-codex-skill",
);
const docsOutputDir = path.resolve(skillRoot, "references", "sdk-docs");

const sourceEntries = [
	"README.md",
	"docs/getting-started.md",
	"docs/manifest-guide.md",
	"docs/api-reference.md",
	"docs/field-types-reference.md",
	"docs/custom-overlays-interop.md",
];

async function readJson(filePath) {
	const raw = await fsp.readFile(filePath, "utf8");
	return JSON.parse(raw);
}

async function ensureSkillExists() {
	try {
		const stats = await fsp.stat(skillRoot);
		if (!stats.isDirectory()) {
			throw new Error(`Skill root is not a directory: ${skillRoot}`);
		}
	} catch (error) {
		throw new Error(
			`Skill folder not found at ${skillRoot}. Create the skill before syncing.`
		);
	}
}

function flattenPath(filePath) {
	return filePath.replaceAll(path.sep, "__").replaceAll("/", "__");
}

async function copyDocs() {
	const copied = [];
	for (const entry of sourceEntries) {
		const sourcePath = path.resolve(projectRoot, entry);
		const sourceStats = await fsp.stat(sourcePath);
		if (!sourceStats.isFile()) {
			throw new Error(`Expected a file but found non-file entry: ${entry}`);
		}

		const destinationName = flattenPath(entry);
		const destinationPath = path.resolve(docsOutputDir, destinationName);
		await fsp.mkdir(path.dirname(destinationPath), { recursive: true });
		await fsp.copyFile(sourcePath, destinationPath);

		copied.push({
			source: entry,
			destination: path.relative(skillRoot, destinationPath).replaceAll("\\", "/"),
		});
	}

	return copied;
}

function buildIndex({ version, copied, generatedAt }) {
	const lines = [
		"# SDK Docs Snapshot",
		"",
		"Generated by `scripts/sync-codex-skill.js`.",
		"",
		`- sdk_version: ${version}`,
		`- generated_at_utc: ${generatedAt}`,
		"",
		"## Included files",
		"",
	];

	for (const item of copied) {
		lines.push(`- \`${item.source}\` -> \`${item.destination}\``);
	}

	lines.push("");
	lines.push("Refresh by running `npm run sync:skills`.");
	lines.push("");

	return lines.join("\n");
}

async function main() {
	await ensureSkillExists();

	const packageJsonPath = path.resolve(projectRoot, "package.json");
	const packageJson = await readJson(packageJsonPath);
	const version = packageJson.version;

	if (typeof version !== "string" || !version.trim()) {
		throw new Error("package.json version is missing or invalid.");
	}

	await fsp.rm(docsOutputDir, { recursive: true, force: true });
	await fsp.mkdir(docsOutputDir, { recursive: true });

	const copied = await copyDocs();
	const generatedAt = new Date().toISOString();
	const indexContent = buildIndex({ version, copied, generatedAt });
	const indexPath = path.resolve(docsOutputDir, "INDEX.md");
	await fsp.writeFile(indexPath, indexContent, "utf8");

	console.log(
		`Synced ${copied.length} SDK docs into ${path.relative(projectRoot, docsOutputDir)}`
	);
	console.log(`Updated ${path.relative(projectRoot, indexPath)} for v${version}`);
}

main().catch((error) => {
	console.error(error.message || error);
	process.exit(1);
});
